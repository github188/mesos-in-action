# 7.5 持续集成系统维护心得

## 7.5.1 持续集成的交付方式

这里的交付方式指的是开发者将项目以何种方式交付给运维人员，或者项目以何种方式部署到服务器。常见的交付方式有

* 源代码交付
> 源代码交付需要将源代码以 tar 包等方式 download 到服务器，然后在服务器上借助程序的构建脚本去构建可执行程序，显然这种方式会经常因服务器环境差异，构建环境初始化失败等问题导致无法构建可执行程序。严重依赖于构建脚本的完备程度。
* 二进制包交付
> 二进制包交付常见的例子是 Linux 标准包的交付，将项目的依赖通过 Linux deb 或者 rpm 来管理，由于这种方式更符合 Linux 规范，间接的提高了项目在服务器上部署的成功率。
* 虚拟镜像交付
> 虚拟镜像交付指的是我们将项目在虚拟机里测试成功后直接将该虚拟镜像部署到服务器上。显然，这种方式部署成功率接近100%。但是随之而来的问题就是虚拟镜像本身对服务器资源的消耗。
* docker image 交付
> docker image 交付是虚拟镜像交付的进一步演进，在保证系统隔离的同时，docker image 对服务器的资源消耗更低。当然，由于 docker 技术仍在发展之中，docker 本身到稳定性还有待提高。我们团队目前正在使用这种方式进行交付。

## 不同环境下的配置管理

对于一个常规的项目来说，开发环境，测试环境与生产环境的配置是不一样的，譬如，这三种环境需要使用不同的域名等。在以 docker 镜像交付时，我们可以通过环境变量来保证配置的差异性。

## 持续集成可靠性的保证

这里我想阐明的是持续集成本身并不能保证项目的可靠性，持续集成是项目可靠性的一个必要非充分条件。只有为你的项目添加单元测试，集成测试等才能达到更可靠的交付。即，可靠交付的更多人力在提高测试覆盖率。

## js 的配置管理问题

js 代码不同于在服务器端运行的代码，JS 在不同环境下的配置管理需要额外的操作，目前已知有两种：

* 使用初始化脚本动态的替换 JS 配置文件中的关键词，即初始化脚本获取环境变量后动态替换 配置文件中相应的值。
* 使用 URL 匹配，为不同的环境设置不同的URL，譬如测试环境与开发环境的URL分别为：
 
  * 测试环境： http://www.mesos-in-action.com?env=test
  * 开发环境： http://www.mesos-in-action.com?env=devel

从而使用不同的 JS 配置文件。这是 StackOverflow 推荐的一个比较优雅的解决方案。

## 自动生成 ReleaseNote

在多人协作的项目开发中，由于多人频繁的 merge 代码，ReleaseNote 的管理也会成为团队的负担。我这里推荐的做法是团队达成一个 agreement：
>对重大 feature 或 bug-fix 的提交都需要在目录 `pending-release` 里面创建相应的 markdown 文件，并将改动添加到里面。

这样，我们可以控制 CI 服务器在构建代码时扫描 `pending-release` 目录并将其中的文本 merge 到一起生成这次构建的 ReleaseNote。

同时，为了避免团队成员忘记这个agreement， 我们还可以在本地的 `git-precommit-hook` 中添加相应的提醒。

## 频繁发布的版本确认

前期，我们团队在频繁发布项目时遇到的一个尴尬问题是无法确认线上版本是不是最新的版本，或者说无法直观的确认新的change是否部署成功。由于我们的项目是通过html页面与用户交互的，我们通过控制 CI 服务器将每次 release 的 `commit id` 缀到 `html` 页面的右下角解决了这个问题。 对于非 Web 项目来说，建议的做法是控制 CI 服务器将每次 Relase 的 `commit id` 推送到一个内部的 Web 服务器，这样，团队就可以非常直观的确认当前版本了。 


## 持续集成的消息通知

显然，团队希望 CI 服务器在执行了持续集成后能够及时的将集成结果通知团队成员，Jenkins 本身是有 `irc notification` 插件的，但是国内开发者可能使用 IRC 的并不多。微信是小团队使用比较多的沟通工具，但是微信不支持机器人调用，退而求其次，我们可以使用 email 通知的方式。或者使用国内的 `LessChart` 等交流工具，它们本身支持 `webhook` 调用。